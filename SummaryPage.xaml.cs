using BioLogicNative.Models;
using System.Text;

namespace BioLogicNative;

public partial class SummaryPage : ContentPage
{
    private List<Hormone> _results;

    public SummaryPage(List<Hormone> problems)
    {
        InitializeComponent();
        _results = problems;
        DetectedList.ItemsSource = _results;
        GenerateStrategy();
    }

    private void GenerateStrategy()
    {
        if (_results == null || !_results.Any()) return;
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–º–µ–Ω –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –≥–æ—Ä–º–æ–Ω–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
        var defects = _results.Select(h => h.Name).ToHashSet();
        var strategyBuilder = new StringBuilder();
        bool hasCritical = false;

        // --- –°–í–Ø–ó–ö–ê 1: –ö–û–†–¢–ò–ó–û–õ (–ö–æ—Ä–æ–ª—å —Å—Ç—Ä–µ—Å—Å–∞) ---
        // –ï—Å–ª–∏ –≤—ã—Å–æ–∫ –ö–æ—Ä—Ç–∏–∑–æ–ª, –æ–Ω –ª–æ–º–∞–µ—Ç –ø–æ—á—Ç–∏ –≤—Å—ë.
        if (defects.Contains("–ö–æ—Ä—Ç–∏–∑–æ–ª"))
        {
            hasCritical = true;
            if (defects.Contains("–¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω"))
            {
                strategyBuilder.AppendLine("üî¥ –ú–ï–¢–ê–ë–û–õ–ò–ß–ï–°–ö–ò–ô –ë–õ–û–ö: –ì–∏–ø–µ—Ä–∫–æ—Ä—Ç–∏–∑–æ–ª–µ–º–∏—è –∏–Ω–≥–∏–±–∏—Ä—É–µ—Ç —Å—Ç–µ—Ä–æ–∏–¥–æ–≥–µ–Ω–µ–∑ –≤ –∫–ª–µ—Ç–∫–∞—Ö –õ–µ–π–¥–∏–≥–∞. –õ—é–±–∞—è —Å—Ç–∏–º—É–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω–∞ –±—É–¥–µ—Ç –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –±–µ–∑ –∫—É–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–µ—Å—Å-—Ñ–∞–∫—Ç–æ—Ä–∞. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–∏—Ä–∫–∞–¥–Ω—ã—Ö —Ä–∏—Ç–º–æ–≤ –∏ –º–∞–≥–Ω–∏–µ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞.");
            }
            else if (defects.Contains("–ê–¥—Ä–µ–Ω–∞–ª–∏–Ω / –ù–æ—Ä–∞–¥—Ä–µ–Ω–∞–ª–∏–Ω"))
            {
                strategyBuilder.AppendLine("üî¥ ADRENAL FATIGUE (–ò—Å—Ç–æ—â–µ–Ω–∏–µ –Ω–∞–¥–ø–æ—á–µ—á–Ω–∏–∫–æ–≤): –ü–∞—Ä–∞–¥–æ–∫—Å–∞–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –∫–æ—Ä—Ç–∏–∑–æ–ª–∞. –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–µ—Ç –Ω–∞ —Å—Ç–∏–º—É–ª—è—Ç–æ—Ä—ã –¶–ù–° (–∫–æ—Ñ–µ–∏–Ω, –ø—Ä–µ–¥—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã). –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ—Ç–æ–∫–æ–ª –∞–¥–∞–ø—Ç–æ–≥–µ–Ω–æ–≤.");
            }
            else
            {
                strategyBuilder.AppendLine("‚ö†Ô∏è –ö–û–†–¢–ò–ó–û–õ –ü–ï–†–í–ò–ß–ï–ù: –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä–Ω–µ–º –≤–∞—à–∏—Ö –ø—Ä–æ–±–ª–µ–º. –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ—Ä—Ç–∏–∑–æ–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ª—É—á—à–∏—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.");
            }
            strategyBuilder.AppendLine(); // –û—Ç—Å—Ç—É–ø
        }

        // --- –°–í–Ø–ó–ö–ê 2: –ü–†–û–õ–ê–ö–¢–ò–ù (–¢–æ—Ä–º–æ–∑ —Å–∏—Å—Ç–µ–º—ã) ---
        if (defects.Contains("–ü—Ä–æ–ª–∞–∫—Ç–∏–Ω") && !strategyBuilder.ToString().Contains("–ü—Ä–æ–ª–∞–∫—Ç–∏–Ω"))
        {
            hasCritical = true;
            if (defects.Contains("–¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω"))
            {
                strategyBuilder.AppendLine("üî¥ –ù–ï–ô–†–û–≠–ù–î–û–ö–†–ò–ù–ù–´–ô –°–ë–û–ô: –ü—Ä–æ–ª–∞–∫—Ç–∏–Ω –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–µ–∫—Ä–µ—Ü–∏—é –≥–æ–Ω–∞–¥–æ—Ç—Ä–æ–ø–∏–Ω–æ–≤ (–õ–ì/–§–°–ì). –¢–µ—Ä–∞–ø–∏—è —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω–æ–≤—ã–º–∏ –±—É—Å—Ç–µ—Ä–∞–º–∏ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–∞. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Ññ1: –¥–æ—Ñ–∞–º–∏–Ω–µ—Ä–≥–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è.");
            }
            else if (defects.Contains("–î–æ—Ñ–∞–º–∏–Ω"))
            {
                strategyBuilder.AppendLine("‚ö†Ô∏è –î–û–§–ê–ú–ò–ù-–ü–†–û–õ–ê–ö–¢–ò–ù: –≠—Ç–æ –≥–æ—Ä–º–æ–Ω—ã-–∞–Ω—Ç–∞–≥–æ–Ω–∏—Å—Ç—ã. –ù–∏–∑–∫–∏–π –î–æ—Ñ–∞–º–∏–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –ü—Ä–æ–ª–∞–∫—Ç–∏–Ω—É —Ä–∞—Å—Ç–∏. –ü–æ–≤—ã—à–µ–Ω–∏–µ –¥–æ—Ñ–∞–º–∏–Ω–∞ (—Ö–æ–ª–æ–¥–Ω—ã–π –¥—É—à, —Ç–∏—Ä–æ–∑–∏–Ω, –ø–æ–±–µ–¥—ã) –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º —Å–Ω–∏–∑–∏—Ç –ø—Ä–æ–ª–∞–∫—Ç–∏–Ω.");
            }
            else
            {
                strategyBuilder.AppendLine("‚ö†Ô∏è –§–ê–ö–¢–û–† –ü–†–û–õ–ê–ö–¢–ò–ù–ê: –≠—Ç–æ—Ç –≥–æ—Ä–º–æ–Ω –≤–≤–æ–¥–∏—Ç –æ—Ä–≥–∞–Ω–∏–∑–º –≤ —Ä–µ–∂–∏–º '—Å–ø—è—á–∫–∏' –∏ –ø–æ–¥–∞–≤–ª—è–µ—Ç –ª–∏–±–∏–¥–æ. –¢—Ä–µ–±—É–µ—Ç –ø—Ä–∏—Ü–µ–ª—å–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏.");
            }
            strategyBuilder.AppendLine();
        }

        // --- –°–í–Ø–ó–ö–ê 3: –≠–°–¢–†–ê–î–ò–û–õ (–ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è) ---
        if (defects.Contains("–≠—Å—Ç—Ä–∞–¥–∏–æ–ª") && defects.Contains("–¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω"))
        {
            hasCritical = true;
            strategyBuilder.AppendLine("üü° –≠–°–¢–†–û–ì–ï–ù–û–í–û–ï –î–û–ú–ò–ù–ò–†–û–í–ê–ù–ò–ï: –í—ã—Å–æ–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω–∞. –†–∏—Å–∫ –≥–∏–Ω–µ–∫–æ–º–∞—Å—Ç–∏–∏ –∏ –∑–∞–¥–µ—Ä–∂–∫–∏ –∂–∏–¥–∫–æ—Å—Ç–∏. –¢—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∂–∏—Ä–æ–≤–æ–π —Ç–∫–∞–Ω–∏ –∏ –∏–Ω–≥–∏–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä–æ–º–∞—Ç–∞–∑—ã.");
            strategyBuilder.AppendLine();
        }

        // --- –°–í–Ø–ó–ö–ê 4: –°–ï–†–û–¢–û–ù–ò–ù vs –î–û–§–ê–ú–ò–ù ---
        if (defects.Contains("–°–µ—Ä–æ—Ç–æ–Ω–∏–Ω") && defects.Contains("–î–æ—Ñ–∞–º–∏–Ω"))
        {
            strategyBuilder.AppendLine("üîµ –ù–ï–ô–†–û–ú–ï–î–ò–ê–¢–û–†–ù–ê–Ø –Ø–ú–ê: –î–µ—Ñ–∏—Ü–∏—Ç —Å–∏—Å—Ç–µ–º—ã –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è –∏ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏—è. –ö–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∞–ø–∞—Ç–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–æ–∫–æ–ª –ø—Ä–µ–∫—É—Ä—Å–æ—Ä–æ–≤ (5-HTP + L-Tyrosine) —Å —Ä–∞–∑–Ω–µ—Å–µ–Ω–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–µ–º–∞.");
            strategyBuilder.AppendLine();
        }

        // --- –ï–°–õ–ò –ù–ï–¢ –°–õ–û–ñ–ù–´–• –°–í–Ø–ó–û–ö ---
        if (string.IsNullOrWhiteSpace(strategyBuilder.ToString()))
        {
            // –ü—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º —Ç–æ–ø-1 –ø—Ä–æ–±–ª–µ–º—É
            var topProblem = _results.First();
            strategyBuilder.AppendLine($"–í–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî {topProblem.Name}. {topProblem.Description}");
            strategyBuilder.AppendLine("–ù–∞—á–Ω–∏—Ç–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–º–æ–Ω–∞.");
        }

        // –í—ã–≤–æ–¥ –≤ UI
        StrategyLabel.Text = strategyBuilder.ToString().Trim();
        
        // –ö—Ä–∞—Å–∏–º —Ä–∞–º–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—è–∂–µ—Å—Ç–∏
        if (hasCritical)
        {
            // –ö—Ä–∞—Å–Ω–∞—è/–û—Ä–∞–Ω–∂–µ–≤–∞—è —Ä–∞–º–∫–∞ –¥–ª—è —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
            StrategyFrame.BorderColor = Colors.OrangeRed;
        }
        else
        {
            // –ó–µ–ª–µ–Ω–∞—è/–°–∏–Ω—è—è –¥–ª—è –æ–±—ã—á–Ω—ã—Ö
            StrategyFrame.BorderColor = Color.FromArgb("#4CC2FF");
        }
    }

    private async void OnOpenProtocolClicked(object sender, EventArgs e)
    {
        await Navigation.PushAsync(new ResultPage(_results));
    }
}
