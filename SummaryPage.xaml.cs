using BioLogicNative.Models;
using System.Text.Json;
using System.Linq;
using System.Text;

namespace BioLogicNative;

[QueryProperty(nameof(Results), "Results")]
public partial class SummaryPage : ContentPage
{
    private List<Hormone> _results;
    public List<Hormone> Results
    {
        get => _results;
        set
        {
            _results = value;
            DetectedList.ItemsSource = _results;
            GenerateStrategy();
        }
    }

    public SummaryPage()
    {
        InitializeComponent();
    }

    private void GenerateStrategy()
    {
        if (Results == null || !Results.Any()) return;
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–º–µ–Ω –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –≥–æ—Ä–º–æ–Ω–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
        var defects = Results.Select(h => h.Name).ToHashSet();
        var strategyBuilder = new StringBuilder();
        bool hasCritical = false;

        // --- –°–í–Ø–ó–ö–ê 1: –ö–û–†–¢–ò–ó–û–õ (–ö–æ—Ä–æ–ª—å —Å—Ç—Ä–µ—Å—Å–∞) ---
        // –ï—Å–ª–∏ –≤—ã—Å–æ–∫ –ö–æ—Ä—Ç–∏–∑–æ–ª, –æ–Ω –ª–æ–º–∞–µ—Ç –ø–æ—á—Ç–∏ –≤—Å—ë.
        if (defects.Contains("–ö–æ—Ä—Ç–∏–∑–æ–ª"))
        {
            hasCritical = true;
            if (defects.Contains("–¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω"))
            {
                strategyBuilder.AppendLine("üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ö–û–ù–§–õ–ò–ö–¢: –°—Ç—Ä–µ—Å—Å (–ö–æ—Ä—Ç–∏–∑–æ–ª) —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –ø–æ–¥–∞–≤–ª—è–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫—É –¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω–∞. –õ—é–±—ã–µ –±—É—Å—Ç–µ—Ä—ã –±—É–¥—É—Ç –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã, –ø–æ–∫–∞ –≤—ã –Ω–µ —Å–Ω–∏–∑–∏—Ç–µ —Å—Ç—Ä–µ—Å—Å–æ–≤—É—é –Ω–∞–≥—Ä—É–∑–∫—É. –ù–∞—á–Ω–∏—Ç–µ —Å —Ä–µ–∂–∏–º–∞ —Å–Ω–∞ –∏ –º–∞–≥–Ω–∏—è.");
            }
            else if (defects.Contains("–ê–¥—Ä–µ–Ω–∞–ª–∏–Ω / –ù–æ—Ä–∞–¥—Ä–µ–Ω–∞–ª–∏–Ω"))
            {
                strategyBuilder.AppendLine("üî¥ –°–ò–ù–î–†–û–ú –í–´–ì–û–†–ê–ù–ò–Ø: –í—ã—Å–æ–∫–∏–π –ö–æ—Ä—Ç–∏–∑–æ–ª –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ê–¥—Ä–µ–Ω–∞–ª–∏–Ω–æ–º –≥–æ–≤–æ—Ä–∏—Ç –æ–± –∏—Å—Ç–æ—â–µ–Ω–∏–∏ –Ω–∞–¥–ø–æ—á–µ—á–Ω–∏–∫–æ–≤. –í–∞–º –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –ó–ê–ü–†–ï–©–ï–ù–´ —Å—Ç–∏–º—É–ª—è—Ç–æ—Ä—ã (–∫–æ—Ñ–µ–∏–Ω, –ø—Ä–µ–¥—Ç—Ä–µ–Ω–∏–∫–∏). –¢–æ–ª—å–∫–æ –º—è–≥–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.");
            }
            else
            {
                strategyBuilder.AppendLine("‚ö†Ô∏è –ö–û–†–¢–ò–ó–û–õ –ü–ï–†–í–ò–ß–ï–ù: –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä–Ω–µ–º –≤–∞—à–∏—Ö –ø—Ä–æ–±–ª–µ–º. –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ—Ä—Ç–∏–∑–æ–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ª—É—á—à–∏—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.");
            }
            strategyBuilder.AppendLine(); // –û—Ç—Å—Ç—É–ø
        }

        // --- –°–í–Ø–ó–ö–ê 2: –ü–†–û–õ–ê–ö–¢–ò–ù (–¢–æ—Ä–º–æ–∑ —Å–∏—Å—Ç–µ–º—ã) ---
        if (defects.Contains("–ü—Ä–æ–ª–∞–∫—Ç–∏–Ω") && !strategyBuilder.ToString().Contains("–ü—Ä–æ–ª–∞–∫—Ç–∏–Ω"))
        {
            hasCritical = true;
            if (defects.Contains("–¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω"))
            {
                strategyBuilder.AppendLine("üî¥ –ë–õ–û–ö–ò–†–û–í–ö–ê –¢–ï–°–¢–û–°–¢–ï–†–û–ù–ê: –í—ã—Å–æ–∫–∏–π –ü—Ä–æ–ª–∞–∫—Ç–∏–Ω –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–∏–≥–Ω–∞–ª –º–æ–∑–≥–∞ –∫ –≤—ã—Ä–∞–±–æ—Ç–∫–µ –¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω–∞. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Ññ1 ‚Äî —Å–Ω–∏–∑–∏—Ç—å –ø—Ä–æ–ª–∞–∫—Ç–∏–Ω (–í–∏—Ç–∞–º–∏–Ω B6, –í–∏—Ç–µ–∫—Å, —Å–Ω–∏–∂–µ–Ω–∏–µ —Å—Ç—Ä–µ—Å—Å–∞).");
            }
            else if (defects.Contains("–î–æ—Ñ–∞–º–∏–Ω"))
            {
                strategyBuilder.AppendLine("‚ö†Ô∏è –î–û–§–ê–ú–ò–ù-–ü–†–û–õ–ê–ö–¢–ò–ù: –≠—Ç–æ –≥–æ—Ä–º–æ–Ω—ã-–∞–Ω—Ç–∞–≥–æ–Ω–∏—Å—Ç—ã. –ù–∏–∑–∫–∏–π –î–æ—Ñ–∞–º–∏–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –ü—Ä–æ–ª–∞–∫—Ç–∏–Ω—É —Ä–∞—Å—Ç–∏. –ü–æ–≤—ã—à–µ–Ω–∏–µ –¥–æ—Ñ–∞–º–∏–Ω–∞ (—Ö–æ–ª–æ–¥–Ω—ã–π –¥—É—à, —Ç–∏—Ä–æ–∑–∏–Ω, –ø–æ–±–µ–¥—ã) –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º —Å–Ω–∏–∑–∏—Ç –ø—Ä–æ–ª–∞–∫—Ç–∏–Ω.");
            }
            else
            {
                strategyBuilder.AppendLine("‚ö†Ô∏è –§–ê–ö–¢–û–† –ü–†–û–õ–ê–ö–¢–ò–ù–ê: –≠—Ç–æ—Ç –≥–æ—Ä–º–æ–Ω –≤–≤–æ–¥–∏—Ç –æ—Ä–≥–∞–Ω–∏–∑–º –≤ —Ä–µ–∂–∏–º '—Å–ø—è—á–∫–∏' –∏ –ø–æ–¥–∞–≤–ª—è–µ—Ç –ª–∏–±–∏–¥–æ. –¢—Ä–µ–±—É–µ—Ç –ø—Ä–∏—Ü–µ–ª—å–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏.");
            }
            strategyBuilder.AppendLine();
        }

        // --- –°–í–Ø–ó–ö–ê 3: –≠–°–¢–†–ê–î–ò–û–õ (–ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è) ---
        if (defects.Contains("–≠—Å—Ç—Ä–∞–¥–∏–æ–ª") && defects.Contains("–¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω"))
        {
            hasCritical = true;
            strategyBuilder.AppendLine("üü† –ê–†–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø: –í–∞—à –¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω, –≤–µ—Ä–æ—è—Ç–Ω–æ, –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –≠—Å—Ç—Ä–∞–¥–∏–æ–ª (—á–∞—Å—Ç–æ –∏–∑-–∑–∞ –ª–∏—à–Ω–µ–≥–æ –≤–µ—Å–∞ –∏–ª–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ —Ü–∏–Ω–∫–∞). –ù—É–∂–Ω—ã –∏–Ω–≥–∏–±–∏—Ç–æ—Ä—ã –∞—Ä–æ–º–∞—Ç–∞–∑—ã (–¶–∏–Ω–∫, DIM, –ë—Ä–æ–∫–∫–æ–ª–∏), –∏–Ω–∞—á–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ –¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω–∞ —Ç–æ–ª—å–∫–æ —É—Ö—É–¥—à–∏—Ç —Å–∏—Ç—É–∞—Ü–∏—é.");
            strategyBuilder.AppendLine();
        }

        // --- –°–í–Ø–ó–ö–ê 4: –°–ï–†–û–¢–û–ù–ò–ù vs –î–û–§–ê–ú–ò–ù ---
        if (defects.Contains("–°–µ—Ä–æ—Ç–æ–Ω–∏–Ω") && defects.Contains("–î–æ—Ñ–∞–º–∏–Ω"))
        {
            strategyBuilder.AppendLine("üîµ –î–ò–°–ë–ê–õ–ê–ù–° –ù–ï–ô–†–û–ú–ï–î–ò–ê–¢–û–†–û–í: –£ –≤–∞—Å –ø—Ä–æ—Å–∞–¥–∫–∞ –∏ –ø–æ '–∫–∞–π—Ñ—É' (–î–æ—Ñ–∞–º–∏–Ω), –∏ –ø–æ '—Å—á–∞—Å—Ç—å—é' (–°–µ—Ä–æ—Ç–æ–Ω–∏–Ω). –≠—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–ø–∞—Ç–∏–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—á–∞—Ç—å —Å –±–∞–∑—ã: —Å–æ–Ω + –ø–∏—Ç–∞–Ω–∏–µ, –∑–∞—Ç–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å 5-HTP (–≤–µ—á–µ—Ä) –∏ –¢–∏—Ä–æ–∑–∏–Ω (—É—Ç—Ä–æ).");
            strategyBuilder.AppendLine();
        }

        // --- –ï–°–õ–ò –ù–ï–¢ –°–õ–û–ñ–ù–´–• –°–í–Ø–ó–û–ö ---
        if (string.IsNullOrWhiteSpace(strategyBuilder.ToString()))
        {
            // –ü—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º —Ç–æ–ø-1 –ø—Ä–æ–±–ª–µ–º—É
            var topProblem = Results.First();
            strategyBuilder.AppendLine($"–í–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî {topProblem.Name}. {topProblem.Description}");
            strategyBuilder.AppendLine("–ù–∞—á–Ω–∏—Ç–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–º–æ–Ω–∞.");
        }

        // –í—ã–≤–æ–¥ –≤ UI
        StrategyLabel.Text = strategyBuilder.ToString().Trim();
        
        // –ö—Ä–∞—Å–∏–º —Ä–∞–º–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—è–∂–µ—Å—Ç–∏
        if (hasCritical)
        {
            // –ö—Ä–∞—Å–Ω–∞—è/–û—Ä–∞–Ω–∂–µ–≤–∞—è —Ä–∞–º–∫–∞ –¥–ª—è —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
            StrategyFrame.BorderColor = Colors.OrangeRed;
        }
        else
        {
            // –ó–µ–ª–µ–Ω–∞—è/–°–∏–Ω—è—è –¥–ª—è –æ–±—ã—á–Ω—ã—Ö
            StrategyFrame.BorderColor = Color.FromArgb("#4CC2FF");
        }
    }

    private async void OnOpenProtocolClicked(object sender, EventArgs e)
    {
        var navigationParameter = new Dictionary<string, object>
        {
            { "Results", _results }
        };
        await Shell.Current.GoToAsync(nameof(ResultPage), navigationParameter);
    }
}
